<script>
	pre (function () {
		ui = frame ('make-account');

		[] .forEach .call (ui .querySelectorAll ('hint[for=input]'), function (_) {
		    _ .outerHTML = input_ify (_);
		});
		
		def = serve (ui);
	})
</script>

<script>
	var make_account =	function (dom, email, password, retype_password) {
		var components = interaction_product ({
			dom: {
				intent: stream (),
				state: stream (dom)
			},
			email: email,
			password: password,
			retype_password: retype_password
		});
		var extension = interaction (transition (function (intent, license) {
			if (intent === 'make') {
			    if (! (email .state () ._ && email .state () .dom .checkValidity ())) {
				    toast ('Please make sure you enter a valid email')
				    return only_ ();
				}
			    else if (password .state () ._ !== retype_password .state () ._) {
				    toast ('Please make sure your passwords match')
				    return only_ ();
				}
			    else
    				return from (function (tenure) {
    					loader ();
    					inquire (api () .register, {
    						email: email .state () ._,
    						password: password .state () ._
    					})
    						.then (function (res) {
    							loader .stop ();
    							tenure .end (true);
    							if (res) {
    								window .location .href = '#trail';
    							}
    							else {
    								toast ('There was a problem creating the account');
    							}
    						})
				    })
			}
			else {
				console .error ('unknown intent passed', intent);
				return only_ ()
			}
		}));
		
		click (dom .querySelector ('[id="action"]'), function () {
			extension .intent ('make');
		})
		
		return interaction_key_sum (components, interaction_product ({ _: extension }))
	}
	
	var email, password, retype_password, i
	self .on ('mount', function () {
		var email_dom = self .root .querySelector ('[id="email"]');
		var password_dom = self .root .querySelector ('[id="password"]');
		var retype_password_dom = self .root .querySelector ('[id="retype-password"]');
		
		email = interaction_placeholder (email_dom .querySelector ('[id="placeholder"]'), interaction_input (email_dom .querySelector ('input')))
		password = interaction_placeholder (password_dom .querySelector ('[id="placeholder"]'), interaction_input (password_dom .querySelector ('input')))
		retype_password = interaction_placeholder (retype_password_dom .querySelector ('[id="placeholder"]'), interaction_input (retype_password_dom .querySelector ('input')))
		i = make_account (self .root, email, password, retype_password);
	
		click (self .root .querySelector ('[id="header"]') .querySelector ('[id="back"]'), function () {
			window .location .href = routes .login;
		})
	})
</script>